FROM ansibleplaybookbundle/apb-base:canary

LABEL "com.redhat.apb.spec"=\
"dmVyc2lvbjogMS4wCm5hbWU6IHZpcnR1YWxpemF0aW9uCmRlc2NyaXB0aW9uOiBLdWJlVmlydCBp\
bnN0YWxsZXIKYmluZGFibGU6IEZhbHNlCmFzeW5jOiBvcHRpb25hbAptZXRhZGF0YToKICBkaXNw\
bGF5TmFtZTogS3ViZXZpcnQKICBsb25nRGVzY3JpcHRpb246IHwKICAgICBLdWJlVmlydCBlbmFi\
bGVzIHRoZSBtaWdyYXRpb24gb2YgZXhpc3RpbmcgdmlydHVhbGl6ZWQgd29ya2xvYWRzIGRpcmVj\
dGx5IGludG8gdGhlIGRldmVsb3BtZW50IHdvcmtmbG93cyBzdXBwb3J0ZWQgYnkgS3ViZXJuZXRl\
cy4KCiAgICAgVGhpcyBwcm92aWRlcyBhIHBhdGggdG8gbW9yZSByYXBpZCBhcHBsaWNhdGlvbiBt\
b2Rlcm5pemF0aW9uIGJ5OgogICAgICAgICAtIFN1cHBvcnRpbmcgZGV2ZWxvcG1lbnQgb2YgbmV3\
IG1pY3Jvc2VydmljZSBhcHBsaWNhdGlvbnMgaW4gY29udGFpbmVycyB0aGF0IGludGVyYWN0IHdp\
dGggZXhpc3RpbmcgdmlydHVhbGl6ZWQgYXBwbGljYXRpb25zLgogICAgICAgICAtIENvbWJpbmlu\
ZyBleGlzdGluZyB2aXJ0dWFsaXplZCB3b3JrbG9hZHMgd2l0aCBuZXcgY29udGFpbmVyIHdvcmts\
b2FkcyBvbiB0aGUgc2FtZSBwbGF0Zm9ybSwgdGhlcmVieSBtYWtpbmcgaXQgZWFzaWVyIHRvIGRl\
Y29tcG9zZSBtb25vbGl0aGljIHZpcnR1YWxpemVkIHdvcmtsb2FkcyBpbnRvIGNvbnRhaW5lcnMg\
b3ZlciB0aW1lLgogIGRvY3VtZW50YXRpb25Vcmw6IGh0dHBzOi8vZ2l0aHViLmNvbS9rdWJldmly\
dC9rdWJldmlydC9ibG9iL21hc3Rlci9SRUFETUUubWQKICBpbWFnZVVybDogaHR0cHM6Ly9jZG4u\
cGJyZC5jby9pbWFnZXMvSDVHdXRkNy5wbmcKICBwcm92aWRlckRpc3BsYXlOYW1lOiAiUmVkIEhh\
dCwgSW5jLiIKcGxhbnM6CiAgLSBuYW1lOiBkZWZhdWx0CiAgICBkZXNjcmlwdGlvbjogRGVmYXVs\
dCBkZXBsb3ltZW50IHBsYW4gZm9yIGt1YmV2aXJ0LWFwYiB3aXRoIG5vIHN0b3JhZ2UKICAgIG1l\
dGFkYXRhOgogICAgICBkaXNwbGF5TmFtZTogRGVmYXVsdAogICAgICBsb25nRGVzY3JpcHRpb246\
IFRoaXMgcGxhbiBwcm92aWRlcyBrdWJldmlydCB3aXRoIG5vIHN0b3JhZ2UKICAgIGZyZWU6IFRy\
dWUKICAgIHBhcmFtZXRlcnM6CiAgICAgIC0gdGl0bGU6IE9wZW5TaGlmdCBBZG1pbiBVc2VyCiAg\
ICAgICAgbmFtZTogYWRtaW5fdXNlcgogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVp\
cmVkOiB0cnVlCiAgICAgIC0gdGl0bGU6IE9wZW5TaGlmdCBBZG1pbiBQYXNzd29yZAogICAgICAg\
IG5hbWU6IGFkbWluX3Bhc3N3b3JkCiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgcmVxdWly\
ZWQ6IHRydWUKICAgICAgICBkaXNwbGF5X3R5cGU6IHBhc3N3b3JkCiAgICAgIC0gbmFtZTogdmVy\
c2lvbgogICAgICAgIHRpdGxlOiBWZXJzaW9uCiAgICAgICAgZGVmYXVsdDogMC42LjAKICAgICAg\
ICBlbnVtOiBbJzAuNi4wJywgJzAuNS4wJywgJzAuNC4wJywgJzAuMy4wJywgJzAuMi4wJywgJzAu\
MS4wJ10KICAgICAgICB0eXBlOiBlbnVtCiAgICAgIC0gbmFtZTogc3RvcmFnZV9yb2xlCiAgICAg\
ICAgdGl0bGU6IEJhY2tlbmQgU3RvcmFnZQogICAgICAgIGRlZmF1bHQ6IHN0b3JhZ2Utbm9uZQog\
ICAgICAgIGVudW06IFsnc3RvcmFnZS1ub25lJ10KICAgICAgICB0eXBlOiBlbnVtCiAgLSBuYW1l\
OiBnbHVzdGVyCiAgICBkZXNjcmlwdGlvbjogRGVwbG95bWVudCBwbGFuIHdpdGggR2x1c3RlciBz\
dG9yYWdlCiAgICBtZXRhZGF0YToKICAgICAgZGlzcGxheU5hbWU6IEt1YmVWaXJ0IHdpdGggR2x1\
c3RlciBTdG9yYWdlCiAgICAgIGxvbmdEZXNjcmlwdGlvbjogVGhpcyBwbGFuIHByb3ZpZGVzIGt1\
YmV2aXJ0IHdpdGggR2x1c3RlciBzdG9yYWdlCiAgICBmcmVlOiBUcnVlCiAgICBwYXJhbWV0ZXJz\
OgogICAgICAtIHRpdGxlOiBPcGVuU2hpZnQgQWRtaW4gVXNlcgogICAgICAgIG5hbWU6IGFkbWlu\
X3VzZXIKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAt\
IHRpdGxlOiBPcGVuU2hpZnQgQWRtaW4gUGFzc3dvcmQKICAgICAgICBuYW1lOiBhZG1pbl9wYXNz\
d29yZAogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAg\
ZGlzcGxheV90eXBlOiBwYXNzd29yZAogICAgICAtIG5hbWU6IHZlcnNpb24KICAgICAgICB0aXRs\
ZTogVmVyc2lvbgogICAgICAgIGRlZmF1bHQ6IDAuNi4wCiAgICAgICAgZW51bTogWycwLjYuMCcs\
ICcwLjUuMCcsICcwLjQuMCcsICcwLjMuMCcsICcwLjIuMCcsICcwLjEuMCddCiAgICAgICAgdHlw\
ZTogZW51bQogICAgICAtIG5hbWU6IHN0b3JhZ2Vfcm9sZQogICAgICAgIHRpdGxlOiBCYWNrZW5k\
IFN0b3JhZ2UKICAgICAgICBkZWZhdWx0OiBzdG9yYWdlLWdsdXN0ZXJmcwogICAgICAgIGVudW06\
IFsnc3RvcmFnZS1nbHVzdGVyZnMnXQogICAgICAgIHR5cGU6IGVudW0KICAgICAgLSB0aXRsZTog\
R2x1c3RlckZTIE5hbWVzcGFjZQogICAgICAgIG5hbWU6IGdsdXN0ZXJmc19uYW1lc3BhY2UKICAg\
ICAgICBkZXNjcmlwdGlvbjoKICAgICAgICAgICJUaGUgbmFtZXNwYWNlIGNvbnRhaW5pbmcgdGhl\
IEdsdXN0ZXJGUyBhbmQgSGVrZXRpIHJlc291cmNlcy4iCiAgICAgICAgdHlwZTogc3RyaW5nCiAg\
ICAgICAgZGlzcGxheV9ncm91cDogR2x1c3RlckZTIFNldHRpbmdzCiAgICAgICAgZGVmYXVsdDog\
ImFwcC1zdG9yYWdlIgogICAgICAtIHRpdGxlOiBHbHVzdGVyRlMgTmFtZQogICAgICAgIG5hbWU6\
IGdsdXN0ZXJmc19uYW1lCiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICAiVGhlIG5hbWUg\
b2YgdGhlIEdsdXN0ZXJGUyBpbnN0YWxsYXRpb24uIgogICAgICAgIHR5cGU6IHN0cmluZwogICAg\
ICAgIGRpc3BsYXlfZ3JvdXA6IEdsdXN0ZXJGUyBTZXR0aW5ncwogICAgICAgIGRlZmF1bHQ6ICJz\
dG9yYWdlIgogICAgICAtIHRpdGxlOiBIZWtldGkgVVJMCiAgICAgICAgbmFtZTogaGVrZXRpX3Vy\
bAogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgIihPcHRpb25hbCkgVVJMIHRvIHJlYWNo\
IHRoZSBIZWtldGkgc2VydmljZS4gVGhpcyBpcyBpZ25vcmVkIGlmIEhla2V0aSBSb3V0ZSBpcwog\
ICAgICAgICAgc3BlY2lmaWVkLiIKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICBkaXNwbGF5\
X2dyb3VwOiBHbHVzdGVyRlMgU2V0dGluZ3MKICAgICAgLSB0aXRsZTogSGVrZXRpIEFkbWluIEtl\
eQogICAgICAgIG5hbWU6IGhla2V0aV9hZG1pbl9rZXkKICAgICAgICBkZXNjcmlwdGlvbjoKICAg\
ICAgICAgICIoT3B0aW9uYWwpIFRoZSBVUkwgdG8gdGhlIEhla2V0aSBzZXJ2aWNlLiBBdXRvLWRl\
dGVjdGVkIGlmIHVuc3BlY2lmaWVkLiIKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICBkaXNw\
bGF5X2dyb3VwOiBHbHVzdGVyRlMgU2V0dGluZ3MKICAgICAgLSB0aXRsZTogVXNlIGV4dGVybmFs\
IHByb3Zpc2lvbmVyPwogICAgICAgIG5hbWU6IGV4dGVybmFsX3Byb3Zpc2lvbmVyCiAgICAgICAg\
ZGVzY3JpcHRpb246CiAgICAgICAgICAiV2hldGhlciB0byB1c2UgdGhlIGV4dGVybmFsIEdsdXN0\
ZXJGUyBwcm92aXNpb25lci4gRW5hYmxlcwogICAgICAgICAgYWRkaXRpb25hbCBmZWF0dXJlcy4i\
CiAgICAgICAgdHlwZTogYm9vbGVhbgogICAgICAgIGRpc3BsYXlfZ3JvdXA6IEdsdXN0ZXJGUyBT\
ZXR0aW5ncwogIC0gbmFtZTogc3RvcmFnZS1kZW1vCiAgICBkZXNjcmlwdGlvbjogRGVwbG95bWVu\
dCBwbGFuIHdpdGggZXBoZW1lcmFsIHN0b3JhZ2UKICAgIG1ldGFkYXRhOgogICAgICBkaXNwbGF5\
TmFtZTogS3ViZVZpcnQgd2l0aCBlcGhlbWVyYWwgU3RvcmFnZQogICAgICBsb25nRGVzY3JpcHRp\
b246IFRoaXMgcGxhbiBwcm92aWRlcyBrdWJldmlydCB3aXRoIGVwaGVtZXJhbCBzdG9yYWdlCiAg\
ICBmcmVlOiBUcnVlCiAgICBwYXJhbWV0ZXJzOgogICAgICAtIHRpdGxlOiBPcGVuU2hpZnQgQWRt\
aW4gVXNlcgogICAgICAgIG5hbWU6IGFkbWluX3VzZXIKICAgICAgICB0eXBlOiBzdHJpbmcKICAg\
ICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAtIHRpdGxlOiBPcGVuU2hpZnQgQWRtaW4gUGFzc3dv\
cmQKICAgICAgICBuYW1lOiBhZG1pbl9wYXNzd29yZAogICAgICAgIHR5cGU6IHN0cmluZwogICAg\
ICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAgZGlzcGxheV90eXBlOiBwYXNzd29yZAogICAgICAt\
IG5hbWU6IHZlcnNpb24KICAgICAgICB0aXRsZTogVmVyc2lvbgogICAgICAgIGRlZmF1bHQ6IDAu\
Ni4wCiAgICAgICAgZW51bTogWycwLjYuMCcsICcwLjUuMCcsICcwLjQuMCcsICcwLjMuMCcsICcw\
LjIuMCcsICcwLjEuMCddCiAgICAgICAgdHlwZTogZW51bQogICAgICAtIG5hbWU6IHN0b3JhZ2Vf\
cm9sZQogICAgICAgIHRpdGxlOiBCYWNrZW5kIFN0b3JhZ2UKICAgICAgICBkZWZhdWx0OiBzdG9y\
YWdlLWRlbW8KICAgICAgICBlbnVtOiBbJ3N0b3JhZ2UtZGVtbyddCiAgICAgICAgdHlwZTogZW51\
bQogIC0gbmFtZTogY2luZGVyCiAgICBkZXNjcmlwdGlvbjogRGVwbG95bWVudCBwbGFuIGZvciBr\
dWJldmlydC1hcGIgd2l0aCBDaW5kZXIgYmFja2VuZAogICAgbWV0YWRhdGE6CiAgICAgIGRpc3Bs\
YXlOYW1lOiBLdWJlVmlydCB3aXRoIENpbmRlciBiYWNrZW5kCiAgICAgIGxvbmdEZXNjcmlwdGlv\
bjogVGhpcyBwbGFuIHByb3ZpZGVzIGt1YmV2aXJ0IHdpdGggQ2luZGVyIGJhY2tlbmQKICAgIGZy\
ZWU6IFRydWUKICAgIHBhcmFtZXRlcnM6CiAgICAgIC0gdGl0bGU6IE9wZW5TaGlmdCBBZG1pbiBV\
c2VyCiAgICAgICAgbmFtZTogYWRtaW5fdXNlcgogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAg\
IHJlcXVpcmVkOiB0cnVlCiAgICAgIC0gdGl0bGU6IE9wZW5TaGlmdCBBZG1pbiBQYXNzd29yZAog\
ICAgICAgIG5hbWU6IGFkbWluX3Bhc3N3b3JkCiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAg\
cmVxdWlyZWQ6IHRydWUKICAgICAgICBkaXNwbGF5X3R5cGU6IHBhc3N3b3JkCiAgICAgIC0gbmFt\
ZTogdmVyc2lvbgogICAgICAgIHRpdGxlOiBWZXJzaW9uCiAgICAgICAgZGVmYXVsdDogMC42LjAK\
ICAgICAgICBlbnVtOiBbJzAuNi4wJywgJzAuNS4wJywgJzAuNC4wJywgJzAuMy4wJywgJzAuMi4w\
JywgJzAuMS4wJ10KICAgICAgICB0eXBlOiBlbnVtCiAgICAgIC0gbmFtZTogc3RvcmFnZV9yb2xl\
CiAgICAgICAgdGl0bGU6IEJhY2tlbmQgU3RvcmFnZQogICAgICAgIGRlZmF1bHQ6IGNpbmRlcgog\
ICAgICAgIGVudW06IFsnY2luZGVyJ10KICAgICAgICB0eXBlOiBlbnVtCg=="


RUN yum install -y iptables wget \
    && yum clean all

### UPSTREAM ONLY ###
COPY requirements.yml /opt/ansible/requirements.yml
COPY download-templates.sh /usr/bin/download-templates
RUN mkdir /opt/apb/kubevirt-templates \
    && download-templates /opt/apb/kubevirt-templates

RUN ansible-galaxy install -r /opt/ansible/requirements.yml \
    && cp -r ./kubevirt-templates /etc/ansible/roles/kubevirt-ansible/roles/kubevirt/templates/
### UPSTREAM ONLY ###

COPY playbooks/* /opt/apb/actions/
COPY inventory /etc/ansible/hosts
RUN chmod -R g=u /opt/{ansible,apb} /etc/ansible/roles

USER apb
