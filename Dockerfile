FROM ansibleplaybookbundle/apb-base:latest

LABEL "com.redhat.apb.spec"=\
"dmVyc2lvbjogMS4wCm5hbWU6IHZpcnR1YWxpemF0aW9uNApkZXNjcmlwdGlvbjogS3ViZVZpcnQg\
aW5zdGFsbGVyCmJpbmRhYmxlOiBGYWxzZQphc3luYzogb3B0aW9uYWwKbWV0YWRhdGE6CiAgZGlz\
cGxheU5hbWU6IEt1YmV2aXJ0CiAgbG9uZ0Rlc2NyaXB0aW9uOiB8CiAgICAgS3ViZVZpcnQgZW5h\
YmxlcyB0aGUgbWlncmF0aW9uIG9mIGV4aXN0aW5nIHZpcnR1YWxpemVkIHdvcmtsb2FkcyBkaXJl\
Y3RseSBpbnRvIHRoZSBkZXZlbG9wbWVudCB3b3JrZmxvd3Mgc3VwcG9ydGVkIGJ5IEt1YmVybmV0\
ZXMuCgogICAgIFRoaXMgcHJvdmlkZXMgYSBwYXRoIHRvIG1vcmUgcmFwaWQgYXBwbGljYXRpb24g\
bW9kZXJuaXphdGlvbiBieToKICAgICAgICAgLSBTdXBwb3J0aW5nIGRldmVsb3BtZW50IG9mIG5l\
dyBtaWNyb3NlcnZpY2UgYXBwbGljYXRpb25zIGluIGNvbnRhaW5lcnMgdGhhdCBpbnRlcmFjdCB3\
aXRoIGV4aXN0aW5nIHZpcnR1YWxpemVkIGFwcGxpY2F0aW9ucy4KICAgICAgICAgLSBDb21iaW5p\
bmcgZXhpc3RpbmcgdmlydHVhbGl6ZWQgd29ya2xvYWRzIHdpdGggbmV3IGNvbnRhaW5lciB3b3Jr\
bG9hZHMgb24gdGhlIHNhbWUgcGxhdGZvcm0sIHRoZXJlYnkgbWFraW5nIGl0IGVhc2llciB0byBk\
ZWNvbXBvc2UgbW9ub2xpdGhpYyB2aXJ0dWFsaXplZCB3b3JrbG9hZHMgaW50byBjb250YWluZXJz\
IG92ZXIgdGltZS4KICBkb2N1bWVudGF0aW9uVXJsOiBodHRwczovL2dpdGh1Yi5jb20va3ViZXZp\
cnQva3ViZXZpcnQvYmxvYi9tYXN0ZXIvUkVBRE1FLm1kCiAgaW1hZ2VVcmw6IGh0dHBzOi8vY2Ru\
LnBicmQuY28vaW1hZ2VzL0g1R3V0ZDcucG5nCiAgcHJvdmlkZXJEaXNwbGF5TmFtZTogIlJlZCBI\
YXQsIEluYy4iCnBsYW5zOgogIC0gbmFtZTogZGVmYXVsdAogICAgZGVzY3JpcHRpb246IERlZmF1\
bHQgZGVwbG95bWVudCBwbGFuIGZvciBrdWJldmlydC1hcGIgdXNpbmcgZXhpc3RpbmcKICAgIG1l\
dGFkYXRhOgogICAgICBkaXNwbGF5TmFtZTogRGVmYXVsdAogICAgICBsb25nRGVzY3JpcHRpb246\
IFRoaXMgcGxhbiBkZXBsb3lzIGt1YmV2aXJ0CiAgICBmcmVlOiBUcnVlCiAgICBwYXJhbWV0ZXJz\
OgogICAgICAtIHRpdGxlOiBPcGVuU2hpZnQgQWRtaW4gVXNlcgogICAgICAgIG5hbWU6IGFkbWlu\
X3VzZXIKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICByZXF1aXJlZDogdHJ1ZQogICAgICAt\
IHRpdGxlOiBPcGVuU2hpZnQgQWRtaW4gUGFzc3dvcmQKICAgICAgICBuYW1lOiBhZG1pbl9wYXNz\
d29yZAogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAg\
ZGlzcGxheV90eXBlOiBwYXNzd29yZAogICAgICAtIG5hbWU6IHZlcnNpb24KICAgICAgICB0aXRs\
ZTogVmVyc2lvbgogICAgICAgIGRlZmF1bHQ6IDAuNi4wCiAgICAgICAgZW51bTogWycwLjYuMCcs\
ICcwLjUuMCcsICcwLjQuMCcsICcwLjMuMCcsICcwLjIuMCcsICcwLjEuMCddCiAgICAgIC0gdGl0\
bGU6IFJlZ2lzdHJ5IFVSTAogICAgICAgIG5hbWU6IHJlZ2lzdHJ5X3VybAogICAgICAgIHR5cGU6\
IHN0cmluZwogICAgICAtIHRpdGxlOiBSZWdpc3RyeSBOYW1lc3BhY2UKICAgICAgICBuYW1lOiBy\
ZWdpc3RyeV9uYW1lc3BhY2UKICAgICAgICB0eXBlOiBzdHJpbmcK"


RUN yum install -y iptables wget \
    && yum clean all

### UPSTREAM ONLY ###
COPY requirements.yml /opt/ansible/requirements.yml
COPY download-templates.sh /usr/bin/download-templates
RUN mkdir /opt/apb/kubevirt-templates \
    && download-templates /opt/apb/kubevirt-templates

RUN ansible-galaxy install -r /opt/ansible/requirements.yml \
    && cp -r ./kubevirt-templates /etc/ansible/roles/kubevirt-ansible/roles/kubevirt/templates/
### UPSTREAM ONLY ###

COPY playbooks/* /opt/apb/actions/
COPY inventory /etc/ansible/hosts
RUN chmod -R g=u /opt/{ansible,apb} /etc/ansible/roles

USER apb
