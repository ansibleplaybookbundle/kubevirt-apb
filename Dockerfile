FROM ansibleplaybookbundle/apb-base:latest

LABEL "com.redhat.apb.spec"=\
"dmVyc2lvbjogMS4wCm5hbWU6IHZpcnR1YWxpemF0aW9uCmRlc2NyaXB0aW9uOiBLdWJlVmlydCBp\
bnN0YWxsZXIKYmluZGFibGU6IEZhbHNlCmFzeW5jOiBvcHRpb25hbAptZXRhZGF0YToKICBkaXNw\
bGF5TmFtZTogS3ViZXZpcnQKICBsb25nRGVzY3JpcHRpb246IHwKICAgICBLdWJlVmlydCBlbmFi\
bGVzIHRoZSBtaWdyYXRpb24gb2YgZXhpc3RpbmcgdmlydHVhbGl6ZWQgd29ya2xvYWRzIGRpcmVj\
dGx5IGludG8gdGhlIGRldmVsb3BtZW50IHdvcmtmbG93cyBzdXBwb3J0ZWQgYnkgS3ViZXJuZXRl\
cy4KCiAgICAgVGhpcyBwcm92aWRlcyBhIHBhdGggdG8gbW9yZSByYXBpZCBhcHBsaWNhdGlvbiBt\
b2Rlcm5pemF0aW9uIGJ5OgogICAgICAgICAtIFN1cHBvcnRpbmcgZGV2ZWxvcG1lbnQgb2YgbmV3\
IG1pY3Jvc2VydmljZSBhcHBsaWNhdGlvbnMgaW4gY29udGFpbmVycyB0aGF0IGludGVyYWN0IHdp\
dGggZXhpc3RpbmcgdmlydHVhbGl6ZWQgYXBwbGljYXRpb25zLgogICAgICAgICAtIENvbWJpbmlu\
ZyBleGlzdGluZyB2aXJ0dWFsaXplZCB3b3JrbG9hZHMgd2l0aCBuZXcgY29udGFpbmVyIHdvcmts\
b2FkcyBvbiB0aGUgc2FtZSBwbGF0Zm9ybSwgdGhlcmVieSBtYWtpbmcgaXQgZWFzaWVyIHRvIGRl\
Y29tcG9zZSBtb25vbGl0aGljIHZpcnR1YWxpemVkIHdvcmtsb2FkcyBpbnRvIGNvbnRhaW5lcnMg\
b3ZlciB0aW1lLgogIGRvY3VtZW50YXRpb25Vcmw6IGh0dHBzOi8vZ2l0aHViLmNvbS9rdWJldmly\
dC9rdWJldmlydC9ibG9iL21hc3Rlci9SRUFETUUubWQKICBpbWFnZVVybDogaHR0cHM6Ly9jZG4u\
cGJyZC5jby9pbWFnZXMvSDVHdXRkNy5wbmcKICBwcm92aWRlckRpc3BsYXlOYW1lOiAiUmVkIEhh\
dCwgSW5jLiIKcGxhbnM6CiAgLSBuYW1lOiBkZWZhdWx0CiAgICBkZXNjcmlwdGlvbjogRGVmYXVs\
dCBkZXBsb3ltZW50IHBsYW4gZm9yIGt1YmV2aXJ0LWFwYiB1c2luZyBleGlzdGluZwogICAgbWV0\
YWRhdGE6CiAgICAgIGRpc3BsYXlOYW1lOiBEZWZhdWx0CiAgICAgIGxvbmdEZXNjcmlwdGlvbjog\
VGhpcyBwbGFuIGRlcGxveXMga3ViZXZpcnQKICAgIGZyZWU6IFRydWUKICAgIHBhcmFtZXRlcnM6\
CiAgICAgIC0gdGl0bGU6IE9wZW5TaGlmdCBBZG1pbiBVc2VyCiAgICAgICAgbmFtZTogYWRtaW5f\
dXNlcgogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgIC0g\
dGl0bGU6IE9wZW5TaGlmdCBBZG1pbiBQYXNzd29yZAogICAgICAgIG5hbWU6IGFkbWluX3Bhc3N3\
b3JkCiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgICBk\
aXNwbGF5X3R5cGU6IHBhc3N3b3JkCiAgICAgIC0gbmFtZTogdmVyc2lvbgogICAgICAgIHRpdGxl\
OiBWZXJzaW9uCiAgICAgICAgZGVmYXVsdDogMC42LjAKICAgICAgICBlbnVtOiBbJzAuNi4wJywg\
JzAuNS4wJywgJzAuNC4wJywgJzAuMy4wJywgJzAuMi4wJywgJzAuMS4wJ10KICAgICAgLSB0aXRs\
ZTogUmVnaXN0cnkgVVJMCiAgICAgICAgbmFtZTogcmVnaXN0cnlfdXJsCiAgICAgICAgdHlwZTog\
c3RyaW5nCiAgICAgIC0gdGl0bGU6IFJlZ2lzdHJ5IE5hbWVzcGFjZQogICAgICAgIG5hbWU6IHJl\
Z2lzdHJ5X25hbWVzcGFjZQogICAgICAgIHR5cGU6IHN0cmluZwo="


RUN yum install -y iptables wget \
    && yum clean all

### UPSTREAM ONLY ###
COPY requirements.yml /opt/ansible/requirements.yml
COPY download-templates.sh /usr/bin/download-templates
RUN mkdir /opt/apb/kubevirt-templates \
    && download-templates /opt/apb/kubevirt-templates

RUN ansible-galaxy install -r /opt/ansible/requirements.yml \
    && cp -r ./kubevirt-templates /etc/ansible/roles/kubevirt-ansible/roles/kubevirt/templates/
### UPSTREAM ONLY ###

COPY playbooks/* /opt/apb/actions/
COPY inventory /etc/ansible/hosts
RUN chmod -R g=u /opt/{ansible,apb} /etc/ansible/roles

USER apb
